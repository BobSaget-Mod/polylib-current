<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>errors.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11.1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>errors.c</h1><a href="errors_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">  $Id: errors_8c-source.html,v 1.1 2002/10/14 15:54:27 olaru Exp $</font>
00003 <font class="comment"></font>
00004 <font class="comment">  Exception management.</font>
00005 <font class="comment">  See "arithmetic_errors.h".</font>
00006 <font class="comment"></font>
00007 <font class="comment">  $Log: errors_8c-source.html,v $
00007 <font class="comment">  Revision 1.1  2002/10/14 15:54:27  olaru
00007 <font class="comment">  New structurated version
00007 <font class="comment"></font>
00008 <font class="comment">  Revision 1.2  2002/08/12 13:11:27  loechner</font>
00009 <font class="comment">  union ehrhart, first complete version</font>
00010 <font class="comment"></font>
00011 <font class="comment">  Revision 1.1.1.1  2001/07/16 15:00:31  risset</font>
00012 <font class="comment">  initial import into CVS</font>
00013 <font class="comment"></font>
00014 <font class="comment">  Revision 1.16  2000/10/27 13:26:03  ancourt</font>
00015 <font class="comment">  exception_thrown -&gt; linear_number_of_exception_thrown</font>
00016 <font class="comment"></font>
00017 <font class="comment">  Revision 1.15  2000/07/27 15:21:55  coelho</font>
00018 <font class="comment">  message++</font>
00019 <font class="comment"></font>
00020 <font class="comment">  Revision 1.14  2000/07/27 14:59:59  coelho</font>
00021 <font class="comment">  trace added.</font>
00022 <font class="comment"></font>
00023 <font class="comment">  Revision 1.13  2000/07/26 08:41:23  coelho</font>
00024 <font class="comment">  the_last_just_thrown_exception management added.</font>
00025 <font class="comment"></font>
00026 <font class="comment">  Revision 1.12  1998/10/26 18:48:34  coelho</font>
00027 <font class="comment">  message++.</font>
00028 <font class="comment"></font>
00029 <font class="comment">  Revision 1.11  1998/10/26 14:38:06  coelho</font>
00030 <font class="comment">  constants back in.</font>
00031 <font class="comment"></font>
00032 <font class="comment">  Revision 1.10  1998/10/26 14:35:47  coelho</font>
00033 <font class="comment">  constants in .h.</font>
00034 <font class="comment"></font>
00035 <font class="comment">  Revision 1.9  1998/10/24 15:36:22  coelho</font>
00036 <font class="comment">  better exception error messages...</font>
00037 <font class="comment"></font>
00038 <font class="comment">  Revision 1.8  1998/10/24 15:19:17  coelho</font>
00039 <font class="comment">  more verbose throw...</font>
00040 <font class="comment"></font>
00041 <font class="comment">  Revision 1.7  1998/10/24 14:31:13  coelho</font>
00042 <font class="comment">  new stack implementation.</font>
00043 <font class="comment">  checks for matching catch/uncatch.</font>
00044 <font class="comment">  debug mode.</font>
00045 <font class="comment"></font>
00046 <font class="comment">  Revision 1.6  1998/10/24 09:31:06  coelho</font>
00047 <font class="comment">  RCS headers.</font>
00048 <font class="comment">  'const' tried.</font>
00049 <font class="comment"></font>
00050 <font class="comment">*/</font>
00051 
00052 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00053 
00054 <font class="preprocessor">#include "<a class="code" href="arithmetique_8h.html">arithmetique.h</a>"</font>
00055 
00056 <font class="comment">/* global constants to designate exceptions.</font>
00057 <font class="comment">   to be put in the type field bellow.</font>
00058 <font class="comment">*/</font>
00059 <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> overflow_error = 1;
00060 <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> simplex_arithmetic_error = 2;
00061 <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> user_exception_error = 4;
00062 <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> parser_exception_error = 8;
00063 <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> any_exception_error = ~0;
00064 
00065 <font class="comment">/* keep track of last thrown exception for RETHROW()</font>
00066 <font class="comment"> */</font>
00067 <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> the_last_just_thrown_exception = 0;
00068 
00069 <font class="comment">/* whether to run in debug mode (that is to trace catch/uncatch/throw)</font>
00070 <font class="comment"> */</font>
00071 <font class="keyword">static</font> <font class="keywordtype">int</font> linear_exception_debug_mode = 0;
00072 <font class="keyword">static</font> <font class="keywordtype">int</font> linear_exception_verbose_mode = 1;
00073 
00074 <font class="comment">/* A structure for the exception stack.</font>
00075 <font class="comment"> */</font>
00076 <font class="keyword">typedef</font> <font class="keyword">struct </font>{
00077   <font class="comment">/* exception type.</font>
00078 <font class="comment">   */</font>
00079   <font class="keywordtype">int</font> what;
00080 
00081   <font class="comment">/* where to jump to.</font>
00082 <font class="comment">   */</font>
00083   jmp_buf where;
00084 
00085   <font class="comment">/* location of the CATCH to be matched against the UNCATCH.</font>
00086 <font class="comment">   */</font>
00087   <font class="keywordtype">char</font> * function;
00088   <font class="keywordtype">char</font> * file;
00089   <font class="keywordtype">int</font>    line;
00090 } 
00091   linear_exception_holder;
00092 
00093 <font class="comment">/* exception stack.</font>
00094 <font class="comment">   maximum extension.</font>
00095 <font class="comment">   current index (next available bucket)</font>
00096 <font class="comment"> */</font>
00097 <font class="preprocessor">#define MAX_STACKED_CONTEXTS 50</font>
00098 <font class="preprocessor"></font><font class="keyword">static</font> linear_exception_holder exception_stack[<a class="code" href="errors_8c.html#a0">MAX_STACKED_CONTEXTS</a>];
00099 <font class="keyword">static</font> <font class="keywordtype">int</font> exception_index = 0;
00100 
00101 <font class="comment">/* total number of exceptions thrown, for statistics.</font>
00102 <font class="comment"> */</font>
00103 <font class="keywordtype">int</font> linear_number_of_exception_thrown = 0;
00104 
00105 <font class="comment">/* dump stack</font>
00106 <font class="comment"> */</font>
00107 <font class="keywordtype">void</font> dump_exception_stack_to_file(FILE * f)<font class="keyword"></font>
00108 <font class="keyword"></font>{
00109   <font class="keywordtype">int</font> i;
00110   fprintf(f, <font class="stringliteral">"[dump_exception_stack_to_file] size=%d\n"</font>, exception_index);
00111   <font class="keywordflow">for</font> (i=0; i&lt;exception_index; i++)
00112   {
00113     fprintf(f, 
00114             <font class="stringliteral">"%d: [%s:%d in %s (%d)]\n"</font>,
00115             i, 
00116             exception_stack[i].file,
00117             exception_stack[i].line,
00118             exception_stack[i].function,
00119             exception_stack[i].what);
00120   }
00121   fprintf(f, <font class="stringliteral">"\n"</font>);
00122 }
00123 
00124 <font class="keywordtype">void</font> dump_exception_stack()<font class="keyword"></font>
00125 <font class="keyword"></font>{
00126   dump_exception_stack_to_file(stderr);
00127 }
00128 
00129 <font class="preprocessor">#define exception_debug_message(type)                             \</font>
00130 <font class="preprocessor">    fprintf(stderr, "%s[%s:%d %s (%d)/%d]\n",                     \</font>
00131 <font class="preprocessor">            type, file, line, function, what, exception_index) </font>
00132 <font class="preprocessor"></font>
00133 <font class="preprocessor">#define exception_debug_trace(type) \</font>
00134 <font class="preprocessor">    if (linear_exception_debug_mode) { exception_debug_message(type); }</font>
00135 <font class="preprocessor"></font>
00136 
00137 <font class="comment">/* push a what exception on stack.</font>
00138 <font class="comment"> */</font>
00139 jmp_buf * 
00140 push_exception_on_stack(
00141     <font class="keywordtype">int</font> what,
00142     <font class="keywordtype">char</font> * function,
00143     <font class="keywordtype">char</font> * file,
00144     <font class="keywordtype">int</font> line)<font class="keyword"></font>
00145 <font class="keyword"></font>{
00146   <a class="code" href="errors_8c.html#a2">exception_debug_trace</a>(<font class="stringliteral">"PUSH "</font>);
00147 
00148   <font class="keywordflow">if</font> (exception_index==<a class="code" href="errors_8c.html#a0">MAX_STACKED_CONTEXTS</a>)
00149   {
00150     <a class="code" href="errors_8c.html#a1">exception_debug_message</a>(<font class="stringliteral">"push"</font>);
00151     fprintf(stderr, <font class="stringliteral">"exception stack overflow\n"</font>);
00152     dump_exception_stack();
00153     abort();
00154   }
00155 
00156   the_last_just_thrown_exception = 0;
00157 
00158   exception_stack[exception_index].what = what;
00159   exception_stack[exception_index].function = function;
00160   exception_stack[exception_index].file = file;
00161   exception_stack[exception_index].line = line;
00162 
00163   <font class="keywordflow">return</font> &amp; exception_stack[exception_index++].where;
00164 }
00165 
00166 <font class="preprocessor">#if !defined(same_string_p)</font>
00167 <font class="preprocessor"></font><font class="preprocessor">#define same_string_p(s1, s2) (strcmp((s1),(s2))==0)</font>
00168 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00169 <font class="preprocessor"></font>
00170 <font class="comment">/* pop a what exception.</font>
00171 <font class="comment">   check for any mismatch!</font>
00172 <font class="comment"> */</font>
00173 <font class="keywordtype">void</font>
00174 pop_exception_from_stack(
00175     <font class="keywordtype">int</font> what,
00176     <font class="keywordtype">char</font> * function,
00177     <font class="keywordtype">char</font> * file,
00178     <font class="keywordtype">int</font> line)<font class="keyword"></font>
00179 <font class="keyword"></font>{  
00180   <a class="code" href="errors_8c.html#a2">exception_debug_trace</a>(<font class="stringliteral">"POP  "</font>);
00181 
00182   <font class="keywordflow">if</font> (exception_index==0)
00183   {
00184     <a class="code" href="errors_8c.html#a1">exception_debug_message</a>(<font class="stringliteral">"pop"</font>);
00185     fprintf(stderr, <font class="stringliteral">"exception stack underflow\n"</font>);
00186     dump_exception_stack();
00187     abort();
00188   }
00189 
00190   exception_index--;
00191   the_last_just_thrown_exception = 0;
00192 
00193   <font class="keywordflow">if</font> ((exception_stack[exception_index].what != what) ||
00194       !<a class="code" href="errors_8c.html#a3">same_string_p</a>(exception_stack[exception_index].file, file) ||
00195       !<a class="code" href="errors_8c.html#a3">same_string_p</a>(exception_stack[exception_index].function, function))<font class="keyword"></font>
00196 <font class="keyword">  </font>{
00197     <a class="code" href="errors_8c.html#a1">exception_debug_message</a>(<font class="stringliteral">"pop"</font>);
00198     fprintf(stderr, 
00199             <font class="stringliteral">"exception stack mismatch at depth=%d:\n"</font>
00200             <font class="stringliteral">"   CATCH: %s:%d in %s (%d)\n"</font>
00201             <font class="stringliteral">" UNCATCH: %s:%d in %s (%d)\n"</font>,
00202             exception_index,
00203             exception_stack[exception_index].file,
00204             exception_stack[exception_index].line,
00205             exception_stack[exception_index].function,
00206             exception_stack[exception_index].what,
00207             file, line, function, what);
00208     dump_exception_stack();
00209     abort();
00210   }
00211 }
00212 
00213 <font class="comment">/* throws an exception of a given type by searching for </font>
00214 <font class="comment">   the specified 'what' in the current exception stack.</font>
00215 <font class="comment">*/</font>
00216 <font class="keywordtype">void</font> throw_exception(
00217     <font class="keywordtype">int</font> what,
00218     <font class="keywordtype">char</font> * function,
00219     <font class="keywordtype">char</font> * file,
00220     <font class="keywordtype">int</font> line)<font class="keyword"></font>
00221 <font class="keyword"></font>{
00222   <font class="keywordtype">int</font> i;
00223   
00224   <a class="code" href="errors_8c.html#a2">exception_debug_trace</a>(<font class="stringliteral">"THROW"</font>);
00225 
00226   the_last_just_thrown_exception = what; <font class="comment">/* for rethrow */</font>
00227 
00228   <font class="keywordflow">for</font> (i=exception_index-1; i&gt;=0; i--)
00229   {
00230     <font class="keywordflow">if</font> (exception_stack[i].what &amp; what) 
00231     {
00232       exception_index = i;
00233       linear_number_of_exception_thrown++;
00234 
00235       <font class="keywordflow">if</font> (linear_exception_debug_mode)
00236         fprintf(stderr, <font class="stringliteral">"----&gt;[%s:%d %s (%d)/%d]\n"</font>, 
00237                 exception_stack[i].file,
00238                 exception_stack[i].line,
00239                 exception_stack[i].function,
00240                 exception_stack[i].what,
00241                 i);
00242   
00243       <font class="keywordflow">if</font> (linear_exception_verbose_mode)
00244         fprintf(stderr, <font class="stringliteral">"exception %d/%d: %s(%s:%d) -&gt; %s(%s:%d)\n"</font>,
00245                 what, exception_stack[i].what,
00246                 function, file, line,
00247                 exception_stack[i].function, 
00248                 exception_stack[i].file,
00249                 exception_stack[i].line);
00250 
00251       longjmp(exception_stack[i].where,0);
00252     }
00253   }
00254 
00255   <font class="comment">/* error. */</font>
00256   <a class="code" href="errors_8c.html#a1">exception_debug_message</a>(<font class="stringliteral">"throw"</font>);
00257   fprintf(stderr,
00258           <font class="stringliteral">"exception not found in stack:\n"</font>
00259           <font class="stringliteral">"an exception was THROWN without a proper matching CATCH\n"</font>);
00260   dump_exception_stack();
00261   abort();
00262 }
</pre></div><hr><address><small>Generated on Fri Oct 4 16:14:26 2002 for Polylib by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.11.1 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
