<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>errors.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>errors.c</h1><a href="errors_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">  $Id: errors_8c-source.html,v 1.2 2002/12/05 11:36:17 loechner Exp $</font>
00003 <font class="comment"></font>
00004 <font class="comment">  Exception management.</font>
00005 <font class="comment">  See "arithmetic_errors.h".</font>
00006 <font class="comment"></font>
00007 <font class="comment">  $Log: errors_8c-source.html,v $
00007 <font class="comment">  Revision 1.2  2002/12/05 11:36:17  loechner
00007 <font class="comment">  fixed a small bug in eval ehrhart
00007 <font class="comment"></font>
00008 <font class="comment">  Revision 1.2  2002/10/15 10:02:07  kienhuis</font>
00009 <font class="comment">  version of arith for new release</font>
00010 <font class="comment"></font>
00011 <font class="comment">  Revision 1.2  2002/08/12 13:11:27  loechner</font>
00012 <font class="comment">  union ehrhart, first complete version</font>
00013 <font class="comment"></font>
00014 <font class="comment">  Revision 1.1.1.1  2001/07/16 15:00:31  risset</font>
00015 <font class="comment">  initial import into CVS</font>
00016 <font class="comment"></font>
00017 <font class="comment">  Revision 1.16  2000/10/27 13:26:03  ancourt</font>
00018 <font class="comment">  exception_thrown -&gt; linear_number_of_exception_thrown</font>
00019 <font class="comment"></font>
00020 <font class="comment">  Revision 1.15  2000/07/27 15:21:55  coelho</font>
00021 <font class="comment">  message++</font>
00022 <font class="comment"></font>
00023 <font class="comment">  Revision 1.14  2000/07/27 14:59:59  coelho</font>
00024 <font class="comment">  trace added.</font>
00025 <font class="comment"></font>
00026 <font class="comment">  Revision 1.13  2000/07/26 08:41:23  coelho</font>
00027 <font class="comment">  the_last_just_thrown_exception management added.</font>
00028 <font class="comment"></font>
00029 <font class="comment">  Revision 1.12  1998/10/26 18:48:34  coelho</font>
00030 <font class="comment">  message++.</font>
00031 <font class="comment"></font>
00032 <font class="comment">  Revision 1.11  1998/10/26 14:38:06  coelho</font>
00033 <font class="comment">  constants back in.</font>
00034 <font class="comment"></font>
00035 <font class="comment">  Revision 1.10  1998/10/26 14:35:47  coelho</font>
00036 <font class="comment">  constants in .h.</font>
00037 <font class="comment"></font>
00038 <font class="comment">  Revision 1.9  1998/10/24 15:36:22  coelho</font>
00039 <font class="comment">  better exception error messages...</font>
00040 <font class="comment"></font>
00041 <font class="comment">  Revision 1.8  1998/10/24 15:19:17  coelho</font>
00042 <font class="comment">  more verbose throw...</font>
00043 <font class="comment"></font>
00044 <font class="comment">  Revision 1.7  1998/10/24 14:31:13  coelho</font>
00045 <font class="comment">  new stack implementation.</font>
00046 <font class="comment">  checks for matching catch/uncatch.</font>
00047 <font class="comment">  debug mode.</font>
00048 <font class="comment"></font>
00049 <font class="comment">  Revision 1.6  1998/10/24 09:31:06  coelho</font>
00050 <font class="comment">  RCS headers.</font>
00051 <font class="comment">  'const' tried.</font>
00052 <font class="comment"></font>
00053 <font class="comment">*/</font>
00054 
00055 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00056 
00057 <font class="preprocessor">#include "<a class="code" href="arithmetique_8h.html">arithmetique.h</a>"</font>
00058 
00059 <font class="comment">/* global constants to designate exceptions.</font>
00060 <font class="comment">   to be put in the type field bellow.</font>
00061 <font class="comment">*/</font>
<a name="l00062"></a><a class="code" href="errors_8c.html#a4">00062</a> <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> <a class="code" href="errors_8c.html#a4">overflow_error</a> = 1;
<a name="l00063"></a><a class="code" href="errors_8c.html#a5">00063</a> <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> <a class="code" href="errors_8c.html#a5">simplex_arithmetic_error</a> = 2;
<a name="l00064"></a><a class="code" href="errors_8c.html#a6">00064</a> <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> <a class="code" href="errors_8c.html#a6">user_exception_error</a> = 4;
<a name="l00065"></a><a class="code" href="errors_8c.html#a7">00065</a> <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> <a class="code" href="errors_8c.html#a7">parser_exception_error</a> = 8;
<a name="l00066"></a><a class="code" href="errors_8c.html#a8">00066</a> <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> <a class="code" href="errors_8c.html#a8">any_exception_error</a> = ~0;
00067 
00068 <font class="comment">/* keep track of last thrown exception for RETHROW()</font>
00069 <font class="comment"> */</font>
<a name="l00070"></a><a class="code" href="errors_8c.html#a9">00070</a> <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> <a class="code" href="errors_8c.html#a9">the_last_just_thrown_exception</a> = 0;
00071 
00072 <font class="comment">/* whether to run in debug mode (that is to trace catch/uncatch/throw)</font>
00073 <font class="comment"> */</font>
<a name="l00074"></a><a class="code" href="errors_8c.html#a10">00074</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="errors_8c.html#a10">linear_exception_debug_mode</a> = 0;
<a name="l00075"></a><a class="code" href="errors_8c.html#a11">00075</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="errors_8c.html#a11">linear_exception_verbose_mode</a> = 1;
00076 
00077 <font class="comment">/* A structure for the exception stack.</font>
00078 <font class="comment"> */</font>
<a name="l00079"></a><a class="code" href="structlinear__exception__holder.html">00079</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
00080   <font class="comment">/* exception type.</font>
00081 <font class="comment">   */</font>
<a name="l00082"></a><a class="code" href="structlinear__exception__holder.html#m0">00082</a>   <font class="keywordtype">int</font> what;
00083 
00084   <font class="comment">/* where to jump to.</font>
00085 <font class="comment">   */</font>
<a name="l00086"></a><a class="code" href="structlinear__exception__holder.html#m1">00086</a>   jmp_buf where;
00087 
00088   <font class="comment">/* location of the CATCH to be matched against the UNCATCH.</font>
00089 <font class="comment">   */</font>
<a name="l00090"></a><a class="code" href="structlinear__exception__holder.html#m2">00090</a>   <font class="keywordtype">char</font> * function;
<a name="l00091"></a><a class="code" href="structlinear__exception__holder.html#m3">00091</a>   <font class="keywordtype">char</font> * file;
<a name="l00092"></a><a class="code" href="structlinear__exception__holder.html#m4">00092</a>   <font class="keywordtype">int</font>    line;
00093 } 
00094   <a class="code" href="structlinear__exception__holder.html">linear_exception_holder</a>;
00095 
00096 <font class="comment">/* exception stack.</font>
00097 <font class="comment">   maximum extension.</font>
00098 <font class="comment">   current index (next available bucket)</font>
00099 <font class="comment"> */</font>
<a name="l00100"></a><a class="code" href="errors_8c.html#a0">00100</a> <font class="preprocessor">#define MAX_STACKED_CONTEXTS 50</font>
<a name="l00101"></a><a class="code" href="errors_8c.html#a12">00101</a> <font class="preprocessor"></font><font class="keyword">static</font> <a class="code" href="structlinear__exception__holder.html">linear_exception_holder</a> <a class="code" href="errors_8c.html#a12">exception_stack</a>[<a class="code" href="errors_8c.html#a0">MAX_STACKED_CONTEXTS</a>];
<a name="l00102"></a><a class="code" href="errors_8c.html#a13">00102</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="errors_8c.html#a13">exception_index</a> = 0;
00103 
00104 <font class="comment">/* total number of exceptions thrown, for statistics.</font>
00105 <font class="comment"> */</font>
<a name="l00106"></a><a class="code" href="errors_8c.html#a14">00106</a> <font class="keywordtype">int</font> <a class="code" href="errors_8c.html#a14">linear_number_of_exception_thrown</a> = 0;
00107 
00108 <font class="comment">/* dump stack</font>
00109 <font class="comment"> */</font>
<a name="l00110"></a><a class="code" href="errors_8c.html#a15">00110</a> <font class="keywordtype">void</font> <a class="code" href="errors_8c.html#a15">dump_exception_stack_to_file</a>(FILE * f)
00111 {
00112   <font class="keywordtype">int</font> i;
00113   fprintf(f, <font class="stringliteral">"[dump_exception_stack_to_file] size=%d\n"</font>, <a class="code" href="errors_8c.html#a13">exception_index</a>);
00114   <font class="keywordflow">for</font> (i=0; i&lt;<a class="code" href="errors_8c.html#a13">exception_index</a>; i++)
00115   {
00116     fprintf(f, 
00117             <font class="stringliteral">"%d: [%s:%d in %s (%d)]\n"</font>,
00118             i, 
00119             exception_stack[i].file,
00120             exception_stack[i].line,
00121             exception_stack[i].function,
00122             exception_stack[i].what);
00123   }
00124   fprintf(f, <font class="stringliteral">"\n"</font>);
00125 }
00126 
<a name="l00127"></a><a class="code" href="errors_8c.html#a16">00127</a> <font class="keywordtype">void</font> <a class="code" href="errors_8c.html#a103">dump_exception_stack</a>()
00128 {
00129   <a class="code" href="errors_8c.html#a15">dump_exception_stack_to_file</a>(stderr);
00130 }
00131 
<a name="l00132"></a><a class="code" href="errors_8c.html#a1">00132</a> <font class="preprocessor">#define exception_debug_message(type)                             \</font>
00133 <font class="preprocessor">    fprintf(stderr, "%s[%s:%d %s (%d)/%d]\n",                     \</font>
00134 <font class="preprocessor">            type, file, line, function, what, exception_index) </font>
00135 <font class="preprocessor"></font>
<a name="l00136"></a><a class="code" href="errors_8c.html#a2">00136</a> <font class="preprocessor">#define exception_debug_trace(type) \</font>
00137 <font class="preprocessor">    if (linear_exception_debug_mode) { exception_debug_message(type); }</font>
00138 <font class="preprocessor"></font>
00139 
00140 <font class="comment">/* push a what exception on stack.</font>
00141 <font class="comment"> */</font>
00142 jmp_buf * 
<a name="l00143"></a><a class="code" href="errors_8c.html#a17">00143</a> <a class="code" href="errors_8c.html#a17">push_exception_on_stack</a>(
00144     <font class="keywordtype">int</font> what,
00145     <font class="keywordtype">char</font> * function,
00146     <font class="keywordtype">char</font> * file,
00147     <font class="keywordtype">int</font> line)
00148 {
00149   <a class="code" href="errors_8c.html#a2">exception_debug_trace</a>(<font class="stringliteral">"PUSH "</font>);
00150 
00151   <font class="keywordflow">if</font> (<a class="code" href="errors_8c.html#a13">exception_index</a>==<a class="code" href="errors_8c.html#a0">MAX_STACKED_CONTEXTS</a>)
00152   {
00153     <a class="code" href="errors_8c.html#a1">exception_debug_message</a>(<font class="stringliteral">"push"</font>);
00154     fprintf(stderr, <font class="stringliteral">"exception stack overflow\n"</font>);
00155     <a class="code" href="errors_8c.html#a103">dump_exception_stack</a>();
00156     abort();
00157   }
00158 
00159   <a class="code" href="errors_8c.html#a9">the_last_just_thrown_exception</a> = 0;
00160 
00161   exception_stack[<a class="code" href="errors_8c.html#a13">exception_index</a>].what = what;
00162   exception_stack[<a class="code" href="errors_8c.html#a13">exception_index</a>].function = function;
00163   exception_stack[<a class="code" href="errors_8c.html#a13">exception_index</a>].file = file;
00164   exception_stack[<a class="code" href="errors_8c.html#a13">exception_index</a>].line = line;
00165 
00166   <font class="keywordflow">return</font> &amp; exception_stack[<a class="code" href="errors_8c.html#a13">exception_index</a>++].where;
00167 }
00168 
00169 <font class="preprocessor">#if !defined(same_string_p)</font>
<a name="l00170"></a><a class="code" href="errors_8c.html#a3">00170</a> <font class="preprocessor"></font><font class="preprocessor">#define same_string_p(s1, s2) (strcmp((s1),(s2))==0)</font>
00171 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00172 <font class="preprocessor"></font>
00173 <font class="comment">/* pop a what exception.</font>
00174 <font class="comment">   check for any mismatch!</font>
00175 <font class="comment"> */</font>
00176 <font class="keywordtype">void</font>
<a name="l00177"></a><a class="code" href="errors_8c.html#a18">00177</a> <a class="code" href="errors_8c.html#a18">pop_exception_from_stack</a>(
00178     <font class="keywordtype">int</font> what,
00179     <font class="keywordtype">char</font> * function,
00180     <font class="keywordtype">char</font> * file,
00181     <font class="keywordtype">int</font> line)
00182 {  
00183   <a class="code" href="errors_8c.html#a2">exception_debug_trace</a>(<font class="stringliteral">"POP  "</font>);
00184 
00185   <font class="keywordflow">if</font> (<a class="code" href="errors_8c.html#a13">exception_index</a>==0)
00186   {
00187     <a class="code" href="errors_8c.html#a1">exception_debug_message</a>(<font class="stringliteral">"pop"</font>);
00188     fprintf(stderr, <font class="stringliteral">"exception stack underflow\n"</font>);
00189     <a class="code" href="errors_8c.html#a103">dump_exception_stack</a>();
00190     abort();
00191   }
00192 
00193   <a class="code" href="errors_8c.html#a13">exception_index</a>--;
00194   <a class="code" href="errors_8c.html#a9">the_last_just_thrown_exception</a> = 0;
00195 
00196   <font class="keywordflow">if</font> ((exception_stack[<a class="code" href="errors_8c.html#a13">exception_index</a>].what != what) ||
00197       !<a class="code" href="errors_8c.html#a3">same_string_p</a>(exception_stack[<a class="code" href="errors_8c.html#a13">exception_index</a>].file, file) ||
00198       !<a class="code" href="errors_8c.html#a3">same_string_p</a>(exception_stack[<a class="code" href="errors_8c.html#a13">exception_index</a>].function, function))
00199   {
00200     <a class="code" href="errors_8c.html#a1">exception_debug_message</a>(<font class="stringliteral">"pop"</font>);
00201     fprintf(stderr, 
00202             <font class="stringliteral">"exception stack mismatch at depth=%d:\n"</font>
00203             <font class="stringliteral">"   CATCH: %s:%d in %s (%d)\n"</font>
00204             <font class="stringliteral">" UNCATCH: %s:%d in %s (%d)\n"</font>,
00205             <a class="code" href="errors_8c.html#a13">exception_index</a>,
00206             exception_stack[<a class="code" href="errors_8c.html#a13">exception_index</a>].file,
00207             exception_stack[<a class="code" href="errors_8c.html#a13">exception_index</a>].line,
00208             exception_stack[<a class="code" href="errors_8c.html#a13">exception_index</a>].function,
00209             exception_stack[<a class="code" href="errors_8c.html#a13">exception_index</a>].what,
00210             file, line, function, what);
00211     <a class="code" href="errors_8c.html#a103">dump_exception_stack</a>();
00212     abort();
00213   }
00214 }
00215 
00216 <font class="comment">/* throws an exception of a given type by searching for </font>
00217 <font class="comment">   the specified 'what' in the current exception stack.</font>
00218 <font class="comment">*/</font>
<a name="l00219"></a><a class="code" href="errors_8c.html#a19">00219</a> <font class="keywordtype">void</font> <a class="code" href="errors_8c.html#a19">throw_exception</a>(
00220     <font class="keywordtype">int</font> what,
00221     <font class="keywordtype">char</font> * function,
00222     <font class="keywordtype">char</font> * file,
00223     <font class="keywordtype">int</font> line)
00224 {
00225   <font class="keywordtype">int</font> i;
00226   
00227   <a class="code" href="errors_8c.html#a2">exception_debug_trace</a>(<font class="stringliteral">"THROW"</font>);
00228 
00229   <a class="code" href="errors_8c.html#a9">the_last_just_thrown_exception</a> = what; <font class="comment">/* for rethrow */</font>
00230 
00231   <font class="keywordflow">for</font> (i=<a class="code" href="errors_8c.html#a13">exception_index</a>-1; i&gt;=0; i--)
00232   {
00233     <font class="keywordflow">if</font> (exception_stack[i].<a class="code" href="structlinear__exception__holder.html#m0">what</a> &amp; what) 
00234     {
00235       <a class="code" href="errors_8c.html#a13">exception_index</a> = i;
00236       <a class="code" href="errors_8c.html#a14">linear_number_of_exception_thrown</a>++;
00237 
00238       <font class="keywordflow">if</font> (linear_exception_debug_mode)
00239         fprintf(stderr, <font class="stringliteral">"----&gt;[%s:%d %s (%d)/%d]\n"</font>, 
00240                 exception_stack[i].file,
00241                 exception_stack[i].line,
00242                 exception_stack[i].function,
00243                 exception_stack[i].what,
00244                 i);
00245   
00246       <font class="keywordflow">if</font> (linear_exception_verbose_mode)
00247         fprintf(stderr, <font class="stringliteral">"exception %d/%d: %s(%s:%d) -&gt; %s(%s:%d)\n"</font>,
00248                 what, exception_stack[i].what,
00249                 function, file, line,
00250                 exception_stack[i].function, 
00251                 exception_stack[i].file,
00252                 exception_stack[i].line);
00253 
00254       longjmp(exception_stack[i].where,0);
00255     }
00256   }
00257 
00258   <font class="comment">/* error. */</font>
00259   <a class="code" href="errors_8c.html#a1">exception_debug_message</a>(<font class="stringliteral">"throw"</font>);
00260   fprintf(stderr,
00261           <font class="stringliteral">"exception not found in stack:\n"</font>
00262           <font class="stringliteral">"an exception was THROWN without a proper matching CATCH\n"</font>);
00263   <a class="code" href="errors_8c.html#a103">dump_exception_stack</a>();
00264   abort();
00265 }
</pre></div><hr><address align="right"><small>Generated on Fri Nov 8 12:10:06 2002 for Polylib by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
